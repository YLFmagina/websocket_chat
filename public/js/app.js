// Generated by CoffeeScript 1.6.3
(function() {
  jQuery(function() {
    var dialog, ws;
    $.fn.editable.defaults.mode = 'inline';
    $('textarea').emojiarea({
      buttonLabel: '插入表情',
      buttonPosition: 'before'
    });
    $('#username').editable({
      type: 'text',
      pk: 1,
      url: '/username',
      title: 'Enter username'
    });
    $('#username').on('save', function(e, params) {
      return location.reload();
    });
    ws = new WebSocket("ws://0.0.0.0:1438");
    ws.onmessage = function(evt) {
      $('#chat tbody:first').append('<tr><td>' + evt.data + '</td></tr>');
      return $('.msg').scrollTop(900000);
    };
    ws.onclose = function() {
      dialog('连接已断开，请刷新页面');
      return ws.send("Leaves the chat");
    };
    ws.onopen = function() {
      $('.emoji-wysiwyg-editor').empty().attr('contenteditable', true);
      return ws.send("Join the chat");
    };
    $("#send").click(function(e) {
      var editor;
      if (ws.readyState !== WebSocket.OPEN) {
        dialog('连接已断开，请刷新页面');
      } else {
        editor = $(".emoji-wysiwyg-editor");
        if (editor.html().length > 0) {
          ws.send(editor.html());
          editor.empty();
        }
      }
      return false;
    });
    $(document).live('keydown', function(e) {
      if (e.ctrlKey && e.keyCode === 13) {
        return $('#send').trigger('click');
      }
    });
    $("#clear").click(function() {
      return $('#chat tbody tr').remove();
    });
    $(document).on('hidden', '#modal', function() {
      return $(this).remove();
    });
    return dialog = function(msg) {
      var html;
      html = "<div id='modal' class='modal hide fade'>    <div class='modal-header'> <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>    <h3>WebSocketChat</h3>    </div>    <div class='modal-body'>      <p>" + msg + "</p>    </div>    <div class='modal-footer'>      <a href='#' aria-hidden='true' data-dismiss='modal' class='btn'>关闭</a>      <a href='#' class='btn btn-primary' onclick='location.reload()'>确认</a>    </div>    </div>";
      $('body').append(html);
      return $('#modal').modal('show');
    };
  });

}).call(this);
